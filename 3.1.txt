3.1 Product Purchase Flow
Structured Flow (hyphen based)
User (Web or Mobile)
- Clicks the "Buy" button
Frontend (Next.js / React Native)
- Sends POST /orders
- Payload: productId, addressId
API Gateway (NestJS)
- Auth middleware validates JWT
Order Module
- Begin database transaction
- Lock product row (FOR UPDATE)
- Validate stock and product status
- Calculate order totals
- Create order record
- Reserve product (status = reserved)
- Commit transaction
- Emit event: order.created
API Response
- Returns orderId and paymentUrl
Payment Module
- Initiate payment process
- Call iyzico API
- Create checkout form
- Return payment URL
User
- Redirected to iyzico 3D Secure page
- Completes payment
Payment Webhook Handler
- Receives POST /webhooks/iyzico
- Verify webhook signature
- Begin database transaction
- Update payment status
- Update order status to paid
- Create payment hold (escrow)
- Update product status to sold
- Commit transaction
- Emit event: order.paid
Queue Publishing (BullMQ / Redis)
- Publish email job
- Publish push notification job
- Publish shipping job
Workers
- EmailWorker sends order confirmation via SendGrid
- PushWorker sends notification via Expo Push
- ShippingWorker creates shipment via Aras Kargo
- Shipment record is stored in the database
Plain Text Explanation
The product purchase flow starts when a user initiates a purchase from either the web or mobile
application by clicking the Buy button. The frontend sends a request to the backend API to create a new
order, including the selected product and delivery address information. The API Gateway first validates the
user authentication using JWT and then forwards the request to the Order module. Within the Order
module, a database transaction is started to ensure consistency. The product row is locked to prevent
concurrent purchases, stock availability and product status are validated, pricing calculations are
performed, and a new order record is created. The product is then reserved and the transaction is
committed. At this point, an order.created event is emitted and the API responds to the client with an order
identifier and a payment URL. The user is redirected to the iyzico 3D Secure payment page to complete
the payment. Once the payment process finishes, iyzico sends a webhook notification back to the system.
The Payment Webhook Handler verifies the authenticity of the webhook, starts a new transaction, updates
the payment and order statuses, creates an escrow payment hold, marks the product as sold, and
commits the transaction. An order.paid event is then emitted. After a successful payment, background jobs
are published to Redis queues using BullMQ. These jobs trigger email notifications, push notifications, and
shipment creation. The email worker sends an order confirmation to the buyer, the push worker notifies the
user in real time, and the shipping worker creates a shipment with the cargo provider and stores the
shipment details in the database. This completes the end-to-end purchase flow.