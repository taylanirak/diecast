// =============================================================================
// TARODAN - COMPLETE Database Schema
// Based on: project.md & schema.md (SINGLE SOURCE OF TRUTH)
// AUDIT REMEDIATION: ALL GAPS CLOSED
// Database: PostgreSQL 16.x
// ORM: Prisma 5.x
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS - COMPLETE LIST
// =============================================================================

enum ProductStatus {
  draft
  pending
  active
  reserved
  sold
  inactive
  rejected
}

enum ProductCondition {
  new
  like_new
  very_good
  good
  fair
}

enum OfferStatus {
  pending
  accepted
  rejected
  expired
  cancelled
}

enum OrderStatus {
  pending_payment
  paid
  preparing
  shipped
  delivered
  completed
  cancelled
  refund_requested
  refunded
}

enum PaymentStatus {
  pending
  processing
  completed
  failed
  refunded
}

enum PaymentHoldStatus {
  held
  released
  cancelled
}

enum ShipmentStatus {
  pending
  label_created
  picked_up
  in_transit
  out_for_delivery
  delivered
  returned
  failed
}

enum AdminRole {
  super_admin
  admin
  moderator
}

enum CommissionRuleType {
  default
  category
  seller_type
  category_seller
}

enum SellerType {
  individual
  verified
  platform
}

// =============================================================================
// GAP-001: TRADE SYSTEM ENUMS (BLOCKER FIX)
// =============================================================================

enum TradeStatus {
  pending              // Trade created, awaiting receiver response
  accepted             // Receiver accepted, awaiting payment/shipping
  rejected             // Receiver declined
  initiator_shipped    // Initiator has shipped their items
  receiver_shipped     // Receiver has shipped their items
  both_shipped         // Both parties have shipped
  initiator_received   // Initiator confirmed receipt
  receiver_received    // Receiver confirmed receipt
  completed            // Both confirmed, trade successful
  cancelled            // Trade cancelled (timeout/manual/dispute)
  disputed             // Issue raised, admin intervention needed
}

// =============================================================================
// GAP-002: MESSAGE STATUS ENUM (BLOCKER FIX)
// =============================================================================

enum MessageStatus {
  sent                 // Clean message, delivered immediately
  pending_approval     // Flagged, awaiting admin review
  approved             // Admin approved, delivered
  rejected             // Admin rejected, not delivered
}

// =============================================================================
// GAP-003: MEMBERSHIP TIER ENUM (BLOCKER FIX)
// =============================================================================

enum MembershipTierType {
  free
  basic
  premium
  business
}

enum SubscriptionStatus {
  active
  cancelled
  expired
  past_due
}

// =============================================================================
// GAP-013: SUPPORT TICKET ENUMS (MEDIUM FIX)
// =============================================================================

enum TicketStatus {
  open
  in_progress
  waiting_customer
  resolved
  closed
}

enum TicketPriority {
  low
  medium
  high
  urgent
}

enum TicketCategory {
  payment
  shipping
  trade
  account
  product
  technical
  other
}

// =============================================================================
// USERS & AUTHENTICATION - EXTENDED FOR ALL GAPS
// =============================================================================

model User {
  id                String       @id @default(uuid())
  email             String       @unique
  phone             String?      @unique
  passwordHash      String       @map("password_hash")
  displayName       String       @map("display_name")
  avatarUrl         String?      @map("avatar_url")
  bio               String?
  birthDate         DateTime?    @map("birth_date")
  isVerified        Boolean      @default(false) @map("is_verified")
  isEmailVerified   Boolean      @default(false) @map("is_email_verified")  // GAP-006
  isPhoneVerified   Boolean      @default(false) @map("is_phone_verified")
  isSeller          Boolean      @default(false) @map("is_seller")
  sellerType        SellerType?  @map("seller_type")
  taxId             String?      @map("tax_id")     // For corporate sellers (Vergi No)
  companyName       String?      @map("company_name") // For corporate sellers
  fcmToken          String?      @map("fcm_token")  // Push notifications
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  // Relations - Existing
  addresses         Address[]
  products          Product[]         @relation("SellerProducts")
  buyerOffers       Offer[]           @relation("BuyerOffers")
  sellerOffers      Offer[]           @relation("SellerOffers")
  buyerOrders       Order[]           @relation("BuyerOrders")
  sellerOrders      Order[]           @relation("SellerOrders")
  paymentHolds      PaymentHold[]
  adminUser         AdminUser?

  // Relations - GAP-001: Trade System
  initiatedTrades   Trade[]           @relation("TradeInitiator")
  receivedTrades    Trade[]           @relation("TradeReceiver")

  // Relations - GAP-002: Messaging System
  sentMessages      Message[]         @relation("MessageSender")
  receivedMessages  Message[]         @relation("MessageReceiver")

  // Relations - GAP-003: Membership System
  membership        UserMembership?

  // Relations - GAP-010: Rating System
  givenRatings      Rating[]          @relation("RatingGiver")
  receivedRatings   Rating[]          @relation("RatingReceiver")
  productRatings    ProductRating[]

  // Relations - GAP-011: Wishlist
  wishlist          Wishlist?

  // Relations - GAP-012: Collections
  collections       Collection[]
  collectionLikes   CollectionLike[]

  // Relations - GAP-013: Support Tickets
  supportTickets    SupportTicket[]   @relation("TicketCreator")
  assignedTickets   SupportTicket[]   @relation("TicketAssignee")
  ticketMessages    TicketMessage[]

  // Relations - Auth Tokens (GAP-004, GAP-005, GAP-006, GAP-009)
  refreshTokens           RefreshToken[]
  passwordResetTokens     PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  twoFactorSecret         TwoFactorSecret?

  // Relations - GAP-014: Push Tokens for Mobile Notifications
  pushTokens              PushToken[]

  // Relations - Invoice System
  buyerInvoices           Invoice[]     @relation("BuyerInvoices")
  sellerInvoices          Invoice[]     @relation("SellerInvoices")

  // Relations - Follow System
  followers               UserFollow[]  @relation("Following")
  following               UserFollow[]  @relation("Followers")

  @@index([email])
  @@index([isSeller])
  @@map("users")
}

// =============================================================================
// GAP-004: TWO-FACTOR AUTHENTICATION (HIGH FIX)
// =============================================================================

model TwoFactorSecret {
  id         String   @id @default(uuid())
  userId     String   @unique @map("user_id")
  secret     String   // TOTP secret (encrypted)
  isEnabled  Boolean  @default(false) @map("is_enabled")
  backupCodes String[] @map("backup_codes") // Encrypted backup codes
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("two_factor_secrets")
}

// =============================================================================
// GAP-005: PASSWORD RESET TOKENS (HIGH FIX)
// =============================================================================

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique // Hashed token
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// =============================================================================
// GAP-006: EMAIL VERIFICATION TOKENS (HIGH FIX)
// =============================================================================

model EmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  email     String   // Email being verified
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("email_verification_tokens")
}

// =============================================================================
// GAP-009: REFRESH TOKEN PERSISTENCE (HIGH FIX)
// =============================================================================

model RefreshToken {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  tokenHash   String    @unique @map("token_hash") // Hashed for security
  deviceInfo  String?   @map("device_info")
  ipAddress   String?   @map("ip_address")
  expiresAt   DateTime  @map("expires_at")
  revokedAt   DateTime? @map("revoked_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// =============================================================================
// ADMIN USER - EXTENDED FOR 2FA
// =============================================================================

model AdminUser {
  id                String      @id @default(uuid())
  userId            String      @unique @map("user_id")
  role              AdminRole
  permissions       Json?       // JSONB for flexible permissions
  isActive          Boolean     @default(true) @map("is_active")
  twoFactorEnabled  Boolean     @default(false) @map("two_factor_enabled") // GAP-004
  lastLoginAt       DateTime?   @map("last_login_at")
  lastLoginIp       String?     @map("last_login_ip")
  createdAt         DateTime    @default(now()) @map("created_at")
  createdBy         String?     @map("created_by")

  // Relations
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  auditLogs         AuditLog[]
  adminSessions     AdminSession[]

  @@map("admin_users")
}

// =============================================================================
// GAP-018: ADMIN SESSION FOR TIMEOUT (MEDIUM FIX)
// =============================================================================

model AdminSession {
  id          String    @id @default(uuid())
  adminUserId String    @map("admin_user_id")
  sessionToken String   @unique @map("session_token")
  ipAddress   String?   @map("ip_address")
  userAgent   String?   @map("user_agent")
  expiresAt   DateTime  @map("expires_at")
  lastActiveAt DateTime @default(now()) @map("last_active_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  adminUser   AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([expiresAt])
  @@map("admin_sessions")
}

model Address {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  title     String?  // e.g., "Home", "Work"
  fullName  String   @map("full_name")
  phone     String
  city      String
  district  String
  address   String
  zipCode   String?  @map("zip_code")
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Trade shipment relations
  tradeShipments TradeShipment[]

  @@map("addresses")
}

// =============================================================================
// GAP-003: MEMBERSHIP TIER SYSTEM (BLOCKER FIX)
// =============================================================================

model MembershipTier {
  id                  String              @id @default(uuid())
  type                MembershipTierType  @unique
  name                String              // Display name
  description         String?
  monthlyPrice        Decimal             @db.Decimal(10, 2) @map("monthly_price")
  yearlyPrice         Decimal             @db.Decimal(10, 2) @map("yearly_price")
  maxFreeListings     Int                 @map("max_free_listings")
  maxTotalListings    Int                 @map("max_total_listings")
  maxImagesPerListing Int                 @map("max_images_per_listing")
  canCreateCollections Boolean            @default(false) @map("can_create_collections")
  canTrade            Boolean             @default(false) @map("can_trade")
  isAdFree            Boolean             @default(false) @map("is_ad_free")
  featuredListingSlots Int               @default(0) @map("featured_listing_slots")
  commissionDiscount  Decimal             @db.Decimal(5, 4) @default(0) @map("commission_discount") // e.g., 0.0050 = 0.5%
  isActive            Boolean             @default(true) @map("is_active")
  sortOrder           Int                 @default(0) @map("sort_order")
  createdAt           DateTime            @default(now()) @map("created_at")
  updatedAt           DateTime            @updatedAt @map("updated_at")

  // Relations
  userMemberships     UserMembership[]

  @@map("membership_tiers")
}

model UserMembership {
  id                 String             @id @default(uuid())
  userId             String             @unique @map("user_id")
  tierId             String             @map("tier_id")
  status             SubscriptionStatus @default(active)
  currentPeriodStart DateTime           @map("current_period_start")
  currentPeriodEnd   DateTime           @map("current_period_end")
  cancelledAt        DateTime?          @map("cancelled_at")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  // Relations
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier               MembershipTier     @relation(fields: [tierId], references: [id])
  payments           MembershipPayment[]

  @@index([userId])
  @@index([status])
  @@map("user_memberships")
}

model MembershipPayment {
  id             String   @id @default(uuid())
  membershipId   String   @map("membership_id")
  amount         Decimal  @db.Decimal(10, 2)
  provider       String   // "iyzico", "paytr"
  providerPaymentId String? @map("provider_payment_id")
  status         PaymentStatus @default(pending)
  periodStart    DateTime @map("period_start")
  periodEnd      DateTime @map("period_end")
  createdAt      DateTime @default(now()) @map("created_at")

  // Relations
  membership     UserMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@map("membership_payments")
}

// =============================================================================
// PRODUCTS & CATEGORIES - EXTENDED
// =============================================================================

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  slug        String    @unique
  description String?
  parentId    String?   @map("parent_id")
  sortOrder   Int       @default(0) @map("sort_order")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  parent          Category?         @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[]        @relation("CategoryHierarchy")
  products        Product[]
  commissionRules CommissionRule[]

  @@map("categories")
}

model Product {
  id             String           @id @default(uuid())
  sellerId       String           @map("seller_id")
  categoryId     String           @map("category_id")
  title          String
  description    String?
  price          Decimal          @db.Decimal(10, 2)
  condition      ProductCondition
  status         ProductStatus    @default(pending)
  isTradeEnabled Boolean          @default(false) @map("is_trade_enabled") // GAP-001
  viewCount      Int              @default(0) @map("view_count")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")
  version        Int              @default(1) // Optimistic locking

  // Relations
  seller         User             @relation("SellerProducts", fields: [sellerId], references: [id])
  category       Category         @relation(fields: [categoryId], references: [id])
  images         ProductImage[]
  offers         Offer[]
  orders         Order[]
  
  // Trade relations (GAP-001)
  tradeItemsOffered  TradeItem[] @relation("TradeItemProduct")
  
  // Wishlist relations (GAP-011)
  wishlistItems  WishlistItem[]
  
  // Collection relations (GAP-012)
  collectionItems CollectionItem[]
  
  // Rating relations (GAP-010)
  productRatings ProductRating[]

  @@index([sellerId])
  @@index([status])
  @@index([isTradeEnabled])
  @@index([createdAt(sort: Desc)])
  @@map("products")
}

model ProductImage {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  url         String
  minioKey    String?  @map("minio_key") // GAP-007: MinIO object key
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

// =============================================================================
// GAP-001: TRADE/SWAP SYSTEM (BLOCKER FIX)
// Full implementation per SYSTEM_OPERATIONS_GUIDE.md
// =============================================================================

model Trade {
  id               String      @id @default(uuid())
  tradeNumber      String      @unique @map("trade_number")
  initiatorId      String      @map("initiator_id")
  receiverId       String      @map("receiver_id")
  status           TradeStatus @default(pending)
  
  // Cash component
  cashAmount       Decimal?    @db.Decimal(10, 2) @map("cash_amount") // Cash to balance trade
  cashPayerId      String?     @map("cash_payer_id") // Who pays the cash
  cashCommission   Decimal?    @db.Decimal(10, 2) @map("cash_commission")
  
  // Message/notes
  initiatorMessage String?     @map("initiator_message")
  receiverMessage  String?     @map("receiver_message")
  
  // Timestamps & Deadlines
  responseDeadline DateTime    @map("response_deadline") // 72 hours from creation
  paymentDeadline  DateTime?   @map("payment_deadline")  // 48 hours from acceptance
  shippingDeadline DateTime?   @map("shipping_deadline") // 7 days from payment
  confirmationDeadline DateTime? @map("confirmation_deadline") // 72 hours after delivery
  
  acceptedAt       DateTime?   @map("accepted_at")
  completedAt      DateTime?   @map("completed_at")
  cancelledAt      DateTime?   @map("cancelled_at")
  cancelReason     String?     @map("cancel_reason")
  
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  version          Int         @default(1) // Optimistic locking

  // Relations
  initiator        User        @relation("TradeInitiator", fields: [initiatorId], references: [id])
  receiver         User        @relation("TradeReceiver", fields: [receiverId], references: [id])
  
  // Trade items offered by initiator
  initiatorItems   TradeItem[] @relation("TradeInitiatorItems")
  // Trade items requested from receiver
  receiverItems    TradeItem[] @relation("TradeReceiverItems")
  
  // Shipments
  shipments        TradeShipment[]
  
  // Cash payment
  cashPayment      TradeCashPayment?
  
  // Dispute
  dispute          TradeDispute?
  
  // Messages within trade
  messages         TradeMessage[]

  @@index([initiatorId])
  @@index([receiverId])
  @@index([status])
  @@index([responseDeadline])
  @@map("trades")
}

model TradeItem {
  id          String   @id @default(uuid())
  tradeId     String   @map("trade_id")
  productId   String   @map("product_id")
  side        String   // "initiator" or "receiver"
  quantity    Int      @default(1)
  valueAtTrade Decimal @db.Decimal(10, 2) @map("value_at_trade") // Price snapshot
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations - Different relations for initiator vs receiver items
  tradeAsInitiatorItem Trade?   @relation("TradeInitiatorItems", fields: [tradeId], references: [id], onDelete: Cascade, map: "trade_initiator_items_fk")
  tradeAsReceiverItem  Trade?   @relation("TradeReceiverItems", fields: [tradeId], references: [id], onDelete: Cascade, map: "trade_receiver_items_fk")
  product              Product  @relation("TradeItemProduct", fields: [productId], references: [id])

  @@index([tradeId])
  @@index([productId])
  @@map("trade_items")
}

model TradeShipment {
  id             String         @id @default(uuid())
  tradeId        String         @map("trade_id")
  shipperId      String         @map("shipper_id") // initiator or receiver user id
  fromAddressId  String         @map("from_address_id")
  carrier        String         // "aras", "yurtici", "mng"
  trackingNumber String?        @map("tracking_number")
  status         ShipmentStatus @default(pending)
  shippedAt      DateTime?      @map("shipped_at")
  deliveredAt    DateTime?      @map("delivered_at")
  confirmedAt    DateTime?      @map("confirmed_at") // Recipient confirmed receipt
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relations
  trade          Trade          @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  fromAddress    Address        @relation(fields: [fromAddressId], references: [id])
  events         TradeShipmentEvent[]

  @@index([tradeId])
  @@map("trade_shipments")
}

model TradeShipmentEvent {
  id              String   @id @default(uuid())
  tradeShipmentId String   @map("trade_shipment_id")
  status          String
  description     String?
  location        String?
  eventTime       DateTime @map("event_time")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  tradeShipment   TradeShipment @relation(fields: [tradeShipmentId], references: [id], onDelete: Cascade)

  @@map("trade_shipment_events")
}

model TradeCashPayment {
  id                String        @id @default(uuid())
  tradeId           String        @unique @map("trade_id")
  payerId           String        @map("payer_id")
  recipientId       String        @map("recipient_id")
  amount            Decimal       @db.Decimal(10, 2)
  commission        Decimal       @db.Decimal(10, 2)
  totalAmount       Decimal       @db.Decimal(10, 2) @map("total_amount") // amount + commission
  provider          String        // "iyzico", "paytr"
  providerPaymentId String?       @map("provider_payment_id")
  status            PaymentStatus @default(pending)
  paidAt            DateTime?     @map("paid_at")
  releasedAt        DateTime?     @map("released_at") // When released to recipient
  refundedAt        DateTime?     @map("refunded_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  trade             Trade         @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@map("trade_cash_payments")
}

model TradeDispute {
  id           String   @id @default(uuid())
  tradeId      String   @unique @map("trade_id")
  raisedById   String   @map("raised_by_id")
  reason       String   // "not_as_described", "damaged", "wrong_item", "not_received"
  description  String
  evidence     Json?    // Array of image URLs
  resolution   String?  // "complete_trade", "cancel_trade", "partial_refund"
  resolvedById String?  @map("resolved_by_id")
  resolvedAt   DateTime? @map("resolved_at")
  resolutionNotes String? @map("resolution_notes")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  trade        Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@map("trade_disputes")
}

model TradeMessage {
  id        String   @id @default(uuid())
  tradeId   String   @map("trade_id")
  senderId  String   @map("sender_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  trade     Trade    @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([tradeId])
  @@map("trade_messages")
}

// =============================================================================
// GAP-002: MESSAGING SYSTEM WITH CONTENT FILTERING (BLOCKER FIX)
// =============================================================================

model MessageThread {
  id           String    @id @default(uuid())
  participant1Id String   @map("participant1_id")
  participant2Id String   @map("participant2_id")
  productId    String?   @map("product_id") // Context: about which product
  lastMessageAt DateTime @default(now()) @map("last_message_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relations
  messages     Message[]

  @@unique([participant1Id, participant2Id, productId])
  @@index([participant1Id])
  @@index([participant2Id])
  @@map("message_threads")
}

model Message {
  id              String        @id @default(uuid())
  threadId        String        @map("thread_id")
  senderId        String        @map("sender_id")
  receiverId      String        @map("receiver_id")
  content         String        // Original content
  filteredContent String?       @map("filtered_content") // Content after filtering
  status          MessageStatus @default(sent)
  flaggedReason   String?       @map("flagged_reason") // Why it was flagged
  reviewedById    String?       @map("reviewed_by_id")
  reviewedAt      DateTime?     @map("reviewed_at")
  readAt          DateTime?     @map("read_at")
  createdAt       DateTime      @default(now()) @map("created_at")

  // Relations
  thread          MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender          User          @relation("MessageSender", fields: [senderId], references: [id])
  receiver        User          @relation("MessageReceiver", fields: [receiverId], references: [id])

  @@index([threadId])
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
  @@map("messages")
}

model ContentFilter {
  id               String   @id @default(uuid())
  filterType       String   @map("filter_type") // "phone", "email", "whatsapp", "social_media", "inappropriate"
  name             String
  pattern          String   // Regex pattern
  replacement      String   @default("[içerik gizlendi]")
  requiresApproval Boolean  @default(true) @map("requires_approval")
  priority         Int      @default(0)
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("content_filters")
}

// =============================================================================
// GAP-010: RATING & REVIEW SYSTEM (HIGH FIX)
// =============================================================================

model Rating {
  id          String   @id @default(uuid())
  giverId     String   @map("giver_id")
  receiverId  String   @map("receiver_id")
  orderId     String?  @map("order_id") // For sale ratings
  tradeId     String?  @map("trade_id") // For trade ratings
  score       Int      // 1-5
  comment     String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  giver       User     @relation("RatingGiver", fields: [giverId], references: [id])
  receiver    User     @relation("RatingReceiver", fields: [receiverId], references: [id])

  @@unique([giverId, orderId])
  @@unique([giverId, tradeId])
  @@index([receiverId])
  @@map("ratings")
}

model ProductRating {
  id        String   @id @default(uuid())
  productId String   @map("product_id")
  userId    String   @map("user_id")
  orderId   String   @unique @map("order_id") // One rating per order
  score     Int      // 1-5
  title     String?
  review    String?
  images    String[] // Review images
  isVerifiedPurchase Boolean @default(true) @map("is_verified_purchase")
  helpfulCount Int   @default(0) @map("helpful_count")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([productId, userId, orderId])
  @@index([productId])
  @@map("product_ratings")
}

// =============================================================================
// GAP-011: WISHLIST / FAVORITES (MEDIUM FIX)
// =============================================================================

model Wishlist {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     WishlistItem[]

  @@map("wishlists")
}

model WishlistItem {
  id         String   @id @default(uuid())
  wishlistId String   @map("wishlist_id")
  productId  String   @map("product_id")
  addedAt    DateTime @default(now()) @map("added_at")

  // Relations
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([wishlistId, productId])
  @@index([productId])
  @@map("wishlist_items")
}

// =============================================================================
// GAP-012: COLLECTIONS SYSTEM (MEDIUM FIX)
// =============================================================================

model Collection {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  name         String
  slug         String   
  description  String?
  coverImageUrl String? @map("cover_image_url")
  isPublic     Boolean  @default(true) @map("is_public")
  viewCount    Int      @default(0) @map("view_count")
  likeCount    Int      @default(0) @map("like_count")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  items        CollectionItem[]
  likes        CollectionLike[]

  @@unique([userId, slug])
  @@index([userId])
  @@index([isPublic])
  @@map("collections")
}

model CollectionItem {
  id           String   @id @default(uuid())
  collectionId String   @map("collection_id")
  productId    String   @map("product_id")
  sortOrder    Int      @default(0) @map("sort_order")
  isFeatured   Boolean  @default(false) @map("is_featured")
  addedAt      DateTime @default(now()) @map("added_at")

  // Relations
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  product      Product    @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([collectionId, productId])
  @@map("collection_items")
}

model CollectionLike {
  id           String   @id @default(uuid())
  collectionId String   @map("collection_id")
  userId      String   @map("user_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([collectionId, userId])
  @@index([collectionId])
  @@index([userId])
  @@map("collection_likes")
}

// =============================================================================
// GAP-013: SUPPORT TICKET SYSTEM (MEDIUM FIX)
// =============================================================================

model SupportTicket {
  id           String         @id @default(uuid())
  ticketNumber String         @unique @map("ticket_number")
  creatorId    String         @map("creator_id")
  assigneeId   String?        @map("assignee_id")
  category     TicketCategory
  priority     TicketPriority @default(medium)
  status       TicketStatus   @default(open)
  subject      String
  orderId      String?        @map("order_id") // Related order if any
  tradeId      String?        @map("trade_id") // Related trade if any
  resolvedAt   DateTime?      @map("resolved_at")
  closedAt     DateTime?      @map("closed_at")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  // Relations
  creator      User           @relation("TicketCreator", fields: [creatorId], references: [id])
  assignee     User?          @relation("TicketAssignee", fields: [assigneeId], references: [id])
  messages     TicketMessage[]

  @@index([creatorId])
  @@index([status])
  @@index([priority])
  @@map("support_tickets")
}

model TicketMessage {
  id        String   @id @default(uuid())
  ticketId  String   @map("ticket_id")
  senderId  String   @map("sender_id")
  content   String
  isInternal Boolean @default(false) @map("is_internal") // Internal notes not visible to user
  attachments String[] // Array of URLs
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  sender    User          @relation(fields: [senderId], references: [id])

  @@index([ticketId])
  @@map("ticket_messages")
}

// =============================================================================
// OFFERS (Teklif Sistemi) - Unchanged
// =============================================================================

model Offer {
  id        String      @id @default(uuid())
  productId String      @map("product_id")
  buyerId   String      @map("buyer_id")
  sellerId  String      @map("seller_id")
  amount    Decimal     @db.Decimal(10, 2)
  status    OfferStatus @default(pending)
  expiresAt DateTime    @map("expires_at")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  version   Int         @default(1) // Optimistic locking

  // Relations
  product   Product     @relation(fields: [productId], references: [id])
  buyer     User        @relation("BuyerOffers", fields: [buyerId], references: [id])
  seller    User        @relation("SellerOffers", fields: [sellerId], references: [id])
  order     Order?      // One offer can create one order

  @@index([productId])
  @@index([status])
  @@map("offers")
}

// =============================================================================
// ORDERS (Sipariş Yönetimi) - Extended with address reference
// =============================================================================

model Order {
  id               String      @id @default(uuid())
  orderNumber      String      @unique @map("order_number")
  buyerId          String      @map("buyer_id")
  sellerId         String      @map("seller_id")
  productId        String      @map("product_id")
  offerId          String?     @unique @map("offer_id")
  shippingAddressId String?    @map("shipping_address_id")
  totalAmount      Decimal     @db.Decimal(10, 2) @map("total_amount")
  shippingCost     Decimal     @db.Decimal(10, 2) @default(0) @map("shipping_cost")
  commissionAmount Decimal     @db.Decimal(10, 2) @map("commission_amount")
  status           OrderStatus @default(pending_payment)
  shippingAddress  Json?       @map("shipping_address") // Snapshot of address at order time
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  version          Int         @default(1) // Optimistic locking

  // Relations
  buyer     User       @relation("BuyerOrders", fields: [buyerId], references: [id])
  seller    User       @relation("SellerOrders", fields: [sellerId], references: [id])
  product   Product    @relation(fields: [productId], references: [id])
  offer     Offer?     @relation(fields: [offerId], references: [id])
  payment   Payment?
  shipment  Shipment?
  invoices  Invoice[]

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@map("orders")
}

// =============================================================================
// PAYMENTS (Ödeme İşlemleri) - Extended
// =============================================================================

model Payment {
  id                  String        @id @default(uuid())
  orderId             String        @unique @map("order_id")
  provider            String        // "iyzico", "paytr"
  providerPaymentId   String?       @map("provider_payment_id")
  providerConversationId String?    @map("provider_conversation_id") // For iyzico
  amount              Decimal       @db.Decimal(10, 2)
  currency            String        @default("TRY")
  installmentCount    Int           @default(1) @map("installment_count")
  status              PaymentStatus @default(pending)
  failureReason       String?       @map("failure_reason")
  metadata            Json?
  paidAt              DateTime?     @map("paid_at")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  // Relations
  order               Order         @relation(fields: [orderId], references: [id])
  paymentHold         PaymentHold?

  @@map("payments")
}

model PaymentHold {
  id          String            @id @default(uuid())
  paymentId   String            @unique @map("payment_id")
  orderId     String            @map("order_id")
  sellerId    String            @map("seller_id")
  amount      Decimal           @db.Decimal(10, 2)
  status      PaymentHoldStatus @default(held)
  releaseAt   DateTime?         @map("release_at") // Scheduled release time
  releasedAt  DateTime?         @map("released_at")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  payment     Payment           @relation(fields: [paymentId], references: [id])
  seller      User              @relation(fields: [sellerId], references: [id])

  @@map("payment_holds")
}

// =============================================================================
// INVOICES (Fatura Sistemi)
// =============================================================================

model Invoice {
  id              String    @id @default(uuid())
  invoiceNumber   String    @unique @map("invoice_number")
  orderId         String    @map("order_id")
  buyerId         String    @map("buyer_id")
  sellerId        String    @map("seller_id")
  subtotal        Decimal   @db.Decimal(10, 2)
  taxAmount       Decimal   @db.Decimal(10, 2) @default(0) @map("tax_amount")
  shippingCost    Decimal   @db.Decimal(10, 2) @default(0) @map("shipping_cost")
  total           Decimal   @db.Decimal(10, 2)
  pdfUrl          String?   @map("pdf_url")
  status          String    @default("issued") // issued, cancelled, refunded
  issuedAt        DateTime  @map("issued_at")
  cancelledAt     DateTime? @map("cancelled_at")
  cancelReason    String?   @map("cancel_reason")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  order           Order     @relation(fields: [orderId], references: [id])
  buyer           User      @relation("BuyerInvoices", fields: [buyerId], references: [id])
  seller          User      @relation("SellerInvoices", fields: [sellerId], references: [id])

  @@index([orderId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([invoiceNumber])
  @@map("invoices")
}

// =============================================================================
// SHIPPING (Kargo Entegrasyonu) - Extended
// =============================================================================

model Shipment {
  id              String         @id @default(uuid())
  orderId         String         @unique @map("order_id")
  provider        String         // "aras", "yurtici", "mng"
  trackingNumber  String?        @map("tracking_number")
  trackingUrl     String?        @map("tracking_url")
  labelUrl        String?        @map("label_url")
  cost            Decimal?       @db.Decimal(10, 2)
  status          ShipmentStatus @default(pending)
  estimatedDelivery DateTime?    @map("estimated_delivery")
  shippedAt       DateTime?      @map("shipped_at")
  deliveredAt     DateTime?      @map("delivered_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  // Relations
  order           Order          @relation(fields: [orderId], references: [id])
  events          ShipmentEvent[]

  @@map("shipments")
}

model ShipmentEvent {
  id          String   @id @default(uuid())
  shipmentId  String   @map("shipment_id")
  status      String
  description String?
  location    String?
  occurredAt  DateTime @map("occurred_at")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  shipment    Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@map("shipment_events")
}

// =============================================================================
// COMMISSION SYSTEM (Komisyon Kuralları) - Extended
// =============================================================================

model CommissionRule {
  id              String             @id @default(uuid())
  name            String
  ruleType        CommissionRuleType @map("rule_type")
  categoryId      String?            @map("category_id")
  sellerType      SellerType?        @map("seller_type")
  membershipTier  MembershipTierType? @map("membership_tier") // Per-tier commission
  minAmount       Decimal?           @db.Decimal(10, 2) @map("min_amount") // Min order amount
  percentage      Decimal            @db.Decimal(5, 4) // e.g., 0.0500 = 5%
  minCommission   Decimal?           @db.Decimal(10, 2) @map("min_commission")
  maxCommission   Decimal?           @db.Decimal(10, 2) @map("max_commission")
  isActive        Boolean            @default(true) @map("is_active")
  priority        Int                @default(0)
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  // Relations
  category        Category?          @relation(fields: [categoryId], references: [id])

  @@index([isActive])
  @@map("commission_rules")
}

// =============================================================================
// PLATFORM SETTINGS (Ayarlar) - Unchanged
// =============================================================================

model PlatformSetting {
  id           String   @id @default(uuid())
  settingKey   String   @unique @map("setting_key")
  settingValue String   @map("setting_value")
  settingType  String   @map("setting_type")
  description  String?
  updatedBy    String?  @map("updated_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("platform_settings")
}

// =============================================================================
// AUDIT & ANALYTICS - Extended
// =============================================================================

model AuditLog {
  id          String   @id @default(uuid())
  adminUserId String   @map("admin_user_id")
  action      String
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  oldValue    Json?    @map("old_value")
  newValue    Json?    @map("new_value")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  adminUser   AdminUser @relation(fields: [adminUserId], references: [id])

  @@index([adminUserId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

model AnalyticsSnapshot {
  id             String   @id @default(uuid())
  snapshotType   String   @map("snapshot_type")
  snapshotDate   DateTime @map("snapshot_date") @db.Date
  totalUsers     Int?     @map("total_users")
  totalProducts  Int?     @map("total_products")
  totalOrders    Int?     @map("total_orders")
  totalTrades    Int?     @map("total_trades")
  totalRevenue   Decimal? @db.Decimal(12, 2) @map("total_revenue")
  newUsers       Int?     @map("new_users")
  newOrders      Int?     @map("new_orders")
  data           Json
  createdAt      DateTime @default(now()) @map("created_at")

  @@unique([snapshotType, snapshotDate])
  @@index([snapshotType, snapshotDate])
  @@map("analytics_snapshots")
}

// =============================================================================
// GAP-007: FILE STORAGE TRACKING (MinIO) (HIGH FIX)
// =============================================================================

model MediaFile {
  id          String   @id @default(uuid())
  bucket      String   // "products", "avatars", "documents", "collections"
  key         String   @unique // MinIO object key
  filename    String   // Original filename
  mimeType    String   @map("mime_type")
  size        Int      // File size in bytes
  uploaderId  String?  @map("uploader_id")
  entityType  String?  @map("entity_type") // "product", "user", "collection", etc.
  entityId    String?  @map("entity_id")
  isPublic    Boolean  @default(true) @map("is_public")
  url         String   // Public URL
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([bucket])
  @@index([entityType, entityId])
  @@map("media_files")
}

// =============================================================================
// GAP-017: CSRF TOKEN STORAGE (MEDIUM FIX)
// =============================================================================

model CsrfToken {
  id          String   @id @default(uuid())
  token       String   @unique
  sessionId   String   @map("session_id")
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([sessionId])
  @@map("csrf_tokens")
}

// =============================================================================
// GAP-020: REDIS CACHE TRACKING (MEDIUM FIX)
// This is just for tracking/debugging - actual cache is in Redis
// =============================================================================

model CacheEntry {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([key])
  @@map("cache_entries")
}

// =============================================================================
// NOTIFICATIONS TRACKING (GAP-014)
// =============================================================================

model NotificationLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  channel      String   // "push", "email", "sms"
  type         String   // Notification type
  title        String
  body         String
  data         Json?    // Additional data
  status       String   // "sent", "failed", "pending"
  errorMessage String?  @map("error_message")
  sentAt       DateTime? @map("sent_at")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([channel])
  @@index([status])
  @@map("notification_logs")
}

// =============================================================================
// GAP-014: PUSH TOKENS (MEDIUM FIX)
// =============================================================================

model PushToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   // Expo push token
  platform  String   // "ios" or "android"
  deviceId  String?  @map("device_id") // Device identifier
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, token])
  @@index([userId])
  @@index([token])
  @@map("push_tokens")
}

// =============================================================================
// GAP-008: ELASTICSEARCH INDEX TRACKING (HIGH FIX)
// =============================================================================

model SearchIndex {
  id            String   @id @default(uuid())
  indexName     String   @unique @map("index_name")
  documentCount Int      @default(0) @map("document_count")
  lastSyncedAt  DateTime? @map("last_synced_at")
  status        String   @default("active") // "active", "rebuilding", "error"
  settings      Json?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("search_indexes")
}

// =============================================================================
// USER FOLLOW SYSTEM
// =============================================================================

model UserFollow {
  id          String   @id @default(uuid())
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_follows")
}

// =============================================================================
// INDEXES SUMMARY
// =============================================================================
// All indexes are defined inline with @@index directives
// Key indexes:
// - User: email, isSeller
// - Product: sellerId, status, isTradeEnabled, createdAt
// - Trade: initiatorId, receiverId, status, responseDeadline
// - Message: threadId, senderId, receiverId, status
// - Order: buyerId, sellerId, status
// - Rating: receiverId
// - SupportTicket: creatorId, status, priority
// - AuditLog: adminUserId, entityType+entityId, createdAt
// - UserFollow: followerId, followingId