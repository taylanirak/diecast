# =============================================================================
# ALERTMANAGER CONFIGURATION - TARODAN Marketplace
# =============================================================================

global:
  # SMTP configuration for email alerts
  smtp_smarthost: 'smtp.sendgrid.net:587'
  smtp_from: 'alerts@tarodan.com'
  smtp_auth_username: 'apikey'
  smtp_auth_password: '${SENDGRID_API_KEY}'
  smtp_require_tls: true
  
  # Slack configuration
  slack_api_url: '${SLACK_WEBHOOK_URL}'

route:
  # Default receiver
  receiver: 'tarodan-default'
  
  # Group alerts by alertname and job
  group_by: ['alertname', 'job', 'severity']
  
  # Wait for 30 seconds before sending grouped alerts
  group_wait: 30s
  
  # Wait 5 minutes before sending repeat alert
  group_interval: 5m
  
  # Wait 4 hours before resending alert
  repeat_interval: 4h
  
  # Child routes for different severities
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'tarodan-critical'
      group_wait: 10s
      repeat_interval: 1h
      
    # Warning alerts
    - match:
        severity: warning
      receiver: 'tarodan-warning'
      group_wait: 5m
      repeat_interval: 12h
      
    # Database team alerts
    - match:
        team: database
      receiver: 'tarodan-database'
      
    # Backend team alerts
    - match:
        team: backend
      receiver: 'tarodan-backend'

receivers:
  # ===========================================================================
  # DEFAULT RECEIVER
  # ===========================================================================
  - name: 'tarodan-default'
    email_configs:
      - to: 'dev@tarodan.com'
        send_resolved: true
        headers:
          Subject: '[TARODAN] {{ .GroupLabels.alertname }} - {{ .Status }}'
    slack_configs:
      - channel: '#tarodan-alerts'
        send_resolved: true
        title: '{{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

  # ===========================================================================
  # CRITICAL RECEIVER - Multiple channels
  # ===========================================================================
  - name: 'tarodan-critical'
    email_configs:
      - to: 'oncall@tarodan.com,dev@tarodan.com'
        send_resolved: true
        headers:
          Subject: 'üö® [CRITICAL] {{ .GroupLabels.alertname }}'
    slack_configs:
      - channel: '#tarodan-critical'
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: 'üö® {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
        actions:
          - type: button
            text: 'View in Grafana'
            url: 'https://grafana.tarodan.com'
          - type: button
            text: 'Silence'
            url: '{{ template "__alert_silence_link" . }}'

  # ===========================================================================
  # WARNING RECEIVER
  # ===========================================================================
  - name: 'tarodan-warning'
    slack_configs:
      - channel: '#tarodan-alerts'
        send_resolved: true
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
        title: '‚ö†Ô∏è {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

  # ===========================================================================
  # DATABASE TEAM RECEIVER
  # ===========================================================================
  - name: 'tarodan-database'
    email_configs:
      - to: 'database-team@tarodan.com'
        send_resolved: true
    slack_configs:
      - channel: '#tarodan-database'
        send_resolved: true

  # ===========================================================================
  # BACKEND TEAM RECEIVER
  # ===========================================================================
  - name: 'tarodan-backend'
    slack_configs:
      - channel: '#tarodan-backend'
        send_resolved: true

# ===========================================================================
# INHIBITION RULES - Prevent alert spam
# ===========================================================================
inhibit_rules:
  # If API is down, don't alert about high latency
  - source_match:
      alertname: 'TarodanAPIDown'
    target_match:
      alertname: 'TarodanSlowResponseTime'
    equal: ['job']
    
  # If DB is down, don't alert about connection issues
  - source_match:
      alertname: 'PostgreSQLDown'
    target_match:
      alertname: 'PostgreSQLHighConnections'
    equal: ['job']

# ===========================================================================
# TEMPLATES
# ===========================================================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'
